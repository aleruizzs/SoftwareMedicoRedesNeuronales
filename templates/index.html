<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>Procesador de ImÃ¡genes MÃ©dicas</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background: #f2f2f2;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      background: #fff;
      width: 100%;
      max-width: 600px;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #333;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .nav-links {
      display: flex;
      gap: 0px;
      align-items: center;
      flex-direction: column;
    }

    .nav-links a,
    .nav-links button {
      display: inline-flex;
      align-items: center;
      background: none;
      border: none;
      color: #2a9d8f;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      padding: 5px 8px;
      transition: color 0.2s ease;
    }

    .nav-links a:hover,
    .nav-links button:hover {
      color: #21867a;
      text-decoration: underline;
    }

    .nav-links button {
      font-family: inherit;
    }


    select,
    input[type="text"],
    input[type="file"],
    button {
      display: block;
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    select:focus,
    input[type="text"]:focus,
    input[type="file"]:focus {
      outline: none;
      border-color: #2a9d8f;
    }
    button {
      background: #e63946;
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    #error-message {
      color: #e63946;
      text-align: center;
      margin-bottom: 15px;
      font-size: 15px;
    }
    #loader-container {
      display: none;
      text-align: center;
      margin-bottom: 15px;
    }
    #loader {
      margin: 0 auto 10px auto;
      border: 8px solid #f3f3f3;
      border-top: 8px solid #2a9d8f;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    #loader-text {
      font-weight: bold;
      color: #2a9d8f;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .download-card {
      display: none;
      background: #2a9d8f;
      color: #fff;
      text-align: center;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      transition: background 0.3s ease, transform 0.3s ease;
      text-decoration: none;
      font-weight: bold;
    }
    .download-card:hover {
      background: #21867a;
    }

    button#procesarButton:hover {
      background: #b92f3a;
    }
    .image-section {
      display: none;
      margin-top: 20px;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    .image-container {
      flex: 1;
      min-width: 45%;
    }
    .image-container h2 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 16px;
      color: #333;
    }
    .image-container img {
      width: 100%;
      border-radius: 8px;
      border: 2px solid #ccc;
      transition: transform 0.3s ease;
      cursor: pointer;
    }
    .image-container img:hover {
      transform: scale(1.02);
      border-color: #2a9d8f;
    }
    @media (max-width: 600px) {
      .image-section {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Analizar Imagen</h1>
    <div class="top-bar">
      <div><strong>Bienvenido, {{ user.username }}</strong></div>
      <div class="nav-links">
        <a href="{% url 'historial' %}" class="nav-item">ðŸ“‚ Historial</a>
        <form action="{% url 'logout' %}" method="post" class="nav-item">
          {% csrf_token %}
          <button type="submit">ðŸšª Cerrar sesiÃ³n</button>
        </form>
      </div>
    </div>

    <select id="model">
      <option value="Columna">Columna</option>
      <option value="Fake">Fake</option>
      <option value="SAM-Med2D">SAM-Med2D</option>
    </select>



    <!-- Coordenadas seleccionadas en la imagen -->
    <input type="hidden" id="pointsInput">

    <input type="text" id="patientDNI" placeholder="DNI del paciente" required>
    <input type="file" id="imageInput" accept="image/jpeg, image/png">

    <button id="procesarButton" onclick="uploadImage()">Procesar Imagen</button>
    <div id="error-message"></div>

    <!-- Spinner -->
    <div id="loader-container">
      <div id="loader"></div>
      <div id="loader-text">Procesando imagen...</div>
    </div>

    <!-- Tarjeta de descarga -->
    <a class="download-card" id="download-link" download="resultado.png">Descargar imagen procesada</a>

    <!-- SecciÃ³n de imÃ¡genes -->
    <div class="image-section" id="image-section">
          <p id="pointInstructions" style="display:none;color:#555;font-size:14px;">Haz clic en la imagen para seleccionar puntos.</p>
      <div class="image-container" style="position:relative;">
        <h2>Imagen Original</h2>
        <img id="originalImage" src="" alt="Imagen original" onclick="openModal(this.src)">
        <canvas id="pointsCanvas" style="position:absolute;top:20 px;left:0;pointer-events:none;"></canvas>
      </div>
      <div class="image-container">
        <h2>Imagen Procesada</h2>
        <img id="processedImage" src="" alt="Imagen procesada" onclick="openModal(this.src)">
      </div>
    </div>
  </div>

  <script>
    const modelSelect = document.getElementById("model");
    const pointsInput = document.getElementById("pointsInput");
    const pointInstructions = document.getElementById("pointInstructions");
    const originalImg = document.getElementById("originalImage");
    const pointsCanvas = document.getElementById("pointsCanvas");
    const ctx = pointsCanvas.getContext("2d");
    const selectedPoints = [];

    function resizeCanvas() {
      pointsCanvas.width = originalImg.clientWidth;
      pointsCanvas.height = originalImg.clientHeight;
      drawPoints();
    }

    function drawPoints() {
      ctx.clearRect(0, 0, pointsCanvas.width, pointsCanvas.height);
      ctx.fillStyle = "red";
      selectedPoints.forEach(pt => {
        const xDisplay = (pt.x / originalImg.naturalWidth) * pointsCanvas.width;
        const yDisplay = (pt.y / originalImg.naturalHeight) * pointsCanvas.height;
        ctx.beginPath();
        ctx.arc(xDisplay, yDisplay, 4, 0, 2 * Math.PI);
        ctx.fill();
      });
    }

    originalImg.addEventListener("load", resizeCanvas);
    window.addEventListener("resize", resizeCanvas);

    originalImg.addEventListener("click", () => {
      if (!originalImg.src) return;
      const enable = modelSelect.value === "SAM-Med2D";
      openModal(originalImg.src, enable);
    });

    modelSelect.addEventListener("change", () => {
      if (modelSelect.value !== "SAM-Med2D") {
        selectedPoints.length = 0;
        pointsInput.value = "";
        drawPoints();
        pointInstructions.style.display = "none";
      } else {
        pointInstructions.style.display = "block";
      }
    });

    if (modelSelect.value === "SAM-Med2D") {
      pointInstructions.style.display = "block";
    }

    document.getElementById("imageInput").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      originalImg.src = url;
      document.getElementById("image-section").style.display = "flex";
      selectedPoints.length = 0;
      pointsInput.value = "";
      drawPoints();
    });

    async function uploadImage() {
      const input = document.getElementById("imageInput");
      const errorMessageDiv = document.getElementById("error-message");
      const imageSection = document.getElementById("image-section");
      const downloadLink = document.getElementById("download-link");
      const downloadCard = document.getElementById("download-link");
      const loaderContainer = document.getElementById("loader-container");
      const csrfToken = document.querySelector('[name=csrf-token]').content;
      
      errorMessageDiv.style.display = "none";
      errorMessageDiv.textContent = "";
      imageSection.style.display = "none";
      downloadCard.style.display = "none";
      loaderContainer.style.display = "block";
      
      if (!input.files.length) {
        alert("Por favor, selecciona una imagen.");
        loaderContainer.style.display = "none";
        return;
      }
      
      const file = input.files[0];
      const dni = document.getElementById("patientDNI").value;
      
      if (!['image/jpeg', 'image/png'].includes(file.type)) {
        loaderContainer.style.display = "none";
        errorMessageDiv.style.display = "block";
        errorMessageDiv.textContent = "El archivo debe ser una imagen en formato JPG, JPEG o PNG.";
        return;
      }
      
      const formData = new FormData();
      const model = document.getElementById("model").value;
      formData.append("image", file);
      formData.append("model", model);
      formData.append("patient_dni", dni);
      if (model === "SAM-Med2D" && pointsInput.value) {
        formData.append("points", pointsInput.value);
      }

      console.time("TotalProcessingTime");

      try {
        const response = await fetch("/process/", {
          method: "POST",
          body: formData,
          credentials: "include",
          headers: {
            "X-CSRFToken": csrfToken
          }
        });
      
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Error en el procesamiento: ${response.status} - ${errorText}`);
        }
        const data = await response.json();
      
        const originalURL = URL.createObjectURL(file);
        document.getElementById("originalImage").src = originalURL;
      
        const processedImageURL = "/" + data.processed_image;
      
        waitForImage(processedImageURL, () => {
          document.getElementById("processedImage").src = processedImageURL;
          imageSection.style.display = "flex";
          downloadLink.href = processedImageURL;
          downloadCard.style.display = "block";
          loaderContainer.style.display = "none";
        });
      
      } catch (error) {
        console.error("Error:", error);
        alert("Hubo un problema al procesar la imagen.");
        loaderContainer.style.display = "none";
      }
      console.timeEnd("TotalProcessingTime");
    }
    
    function waitForImage(imageUrl, callback, attempts = 20) {
      if (attempts === 0) {
        console.error("No se pudo cargar la imagen procesada.");
        return;
      }
      fetch(imageUrl, { method: "HEAD" })
        .then(response => {
          if (response.ok) {
            callback();
          } else {
            setTimeout(() => waitForImage(imageUrl, callback, attempts - 1), 1000);
          }
        })
        .catch(() => {
          setTimeout(() => waitForImage(imageUrl, callback, attempts - 1), 1000);
        });
    }

    function drawPointsOn(canvas, img) {
      const cctx = canvas.getContext("2d");
      cctx.clearRect(0, 0, canvas.width, canvas.height);
      cctx.fillStyle = "red";
      selectedPoints.forEach(pt => {
        const x = (pt.x / img.naturalWidth) * canvas.width;
        const y = (pt.y / img.naturalHeight) * canvas.height;
        cctx.beginPath();
        cctx.arc(x, y, 4, 0, 2 * Math.PI);
        cctx.fill();
      });
    }

    function openModal(imageSrc, enableSelection = false) {
      const modal = document.createElement("div");
      Object.assign(modal.style, {
        position: "fixed",
        top: 0,
        left: 0,
        width: "100%",
        height: "100%",
        backgroundColor: "rgba(0, 0, 0, 0.8)",
        display: "flex",
        justifyContent: "center",
        alignItems: "center"
      });

      const container = document.createElement("div");
      container.style.position = "relative";

      const img = document.createElement("img");
      img.src = imageSrc;
      img.style.maxWidth = "90%";
      img.style.maxHeight = "90%";

      container.appendChild(img);

      let canvas;
      if (enableSelection) {
        canvas = document.createElement("canvas");
        canvas.style.position = "absolute";
        canvas.style.top = "0";
        canvas.style.left = "0";
        container.appendChild(canvas);

        function resize() {
          canvas.width = img.clientWidth;
          canvas.height = img.clientHeight;
          drawPointsOn(canvas, img);
        }

        img.addEventListener("load", resize);
        window.addEventListener("resize", resize);
        resize();

        canvas.addEventListener("click", e => {
          const rect = canvas.getBoundingClientRect();
          const xDisp = e.clientX - rect.left;
          const yDisp = e.clientY - rect.top;
          const scaleX = img.naturalWidth / img.clientWidth;
          const scaleY = img.naturalHeight / img.clientHeight;
          const x = Math.round(xDisp * scaleX);
          const y = Math.round(yDisp * scaleY);
          selectedPoints.push({ x, y });
          pointsInput.value = selectedPoints.map(p => `${p.x},${p.y}`).join(";");
          drawPointsOn(canvas, img);
          drawPoints();
        });
      }

      modal.addEventListener("click", e => {
        if (e.target === modal) {
          document.body.removeChild(modal);
        }
      });

      modal.appendChild(container);
      document.body.appendChild(modal);
    }


  </script>
</body>
</html>
